<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>NepCTF-九龙拉棺-复现 | l0v3m1ng`s blog</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>NepCTF-九龙拉棺-复现</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-11-27T10:15:30.000Z" id="date"> 2023-11-27</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-11-27T10:16:25.455Z" id="updated"> 2023-11-27</time></div></span></div></div><hr><div id="post-content"><h1 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h1><p>首先对main函数进行分析，可以看出主要的内容都在创建的线程中。线程之间通过全局变量实现同步，静态分析即可看出执行顺序。</p>
<p>线程一：</p>
<p>使用rc4初始化block，key为MessageBoxA，长度为0x3478，之后信号量变为3。</p>
<p>线程三：</p>
<p>使用base32加密block中的内容</p>
<p>线程二：</p>
<p>用来进行反调试的线程，原理很简单，就是定时校验代码段的完整性，在线程启动前将断点打好就可以绕过。还有查看drx7寄存器的状态来判断硬件断点。</p>
<p>知道这些就没必要一个一个加密进行分析了，直接打断点看一看这个资源加密（或者该说是解密后的样子，定位到最后一个对该资源地址操作的地址，在线程六中打断点即可看到资源被解密成了一个pe文件，在线程六中作为子进程启动。</p>
<p>将该pe文件dump出来即可进行分析，子进程用到了MapViewOfFile函数，实现对输入的访问，对输入的后半段进行tea加密后，与密文进行比较，返回比较结果。</p>
<p>输入的其余部分在线程七中进行tea加密，两段tea差别在于key不一样，对两段tea进行解密即可得到flag。</p>
<h1 id="一些收获"><a href="#一些收获" class="headerlink" title="一些收获"></a>一些收获</h1><h2 id="提升进程权限"><a href="#提升进程权限" class="headerlink" title="提升进程权限"></a>提升进程权限</h2><p>提升权限代码，要对一个任意进程给予相应的权限，要修改进程的访问令牌，首先要获得进程的访问令牌，通过以下代码可以获取访问令牌</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">OpenProcessToken(GetCurrentProcess(),TOKEN_ADJUST_PRIVILEGES,&amp;hToken)<br></code></pre></td></tr></table></figure>

<p>之后对令牌进行检查和修改</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib, <span class="hljs-string">&quot;advapi32.lib&quot;</span>)</span><br><br>BOOL <span class="hljs-title function_">SetPrivilege</span><span class="hljs-params">(</span><br><span class="hljs-params">    HANDLE hToken,          <span class="hljs-comment">// access token handle</span></span><br><span class="hljs-params">    LPCTSTR lpszPrivilege,  <span class="hljs-comment">// name of privilege to enable/disable</span></span><br><span class="hljs-params">    BOOL bEnablePrivilege   <span class="hljs-comment">// to enable or disable privilege</span></span><br><span class="hljs-params">    )</span> <br>&#123;<br>    TOKEN_PRIVILEGES tp;<br>    LUID luid;<br><br>    <span class="hljs-keyword">if</span> ( !LookupPrivilegeValue( <br>            <span class="hljs-literal">NULL</span>,            <span class="hljs-comment">// lookup privilege on local system</span><br>            lpszPrivilege,   <span class="hljs-comment">// privilege to lookup </span><br>            &amp;luid ) )        <span class="hljs-comment">// receives LUID of privilege</span><br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;LookupPrivilegeValue error: %u\n&quot;</span>, GetLastError() ); <br>        <span class="hljs-keyword">return</span> FALSE; <br>    &#125;<br><br>    tp.PrivilegeCount = <span class="hljs-number">1</span>;<br>    tp.Privileges[<span class="hljs-number">0</span>].Luid = luid;<br>    <span class="hljs-keyword">if</span> (bEnablePrivilege)<br>        tp.Privileges[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;<br>    <span class="hljs-keyword">else</span><br>        tp.Privileges[<span class="hljs-number">0</span>].Attributes = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// Enable the privilege or disable all privileges.</span><br><br>    <span class="hljs-keyword">if</span> ( !AdjustTokenPrivileges(<br>           hToken, <br>           FALSE, <br>           &amp;tp, <br>           <span class="hljs-keyword">sizeof</span>(TOKEN_PRIVILEGES), <br>           (PTOKEN_PRIVILEGES) <span class="hljs-literal">NULL</span>, <br>           (PDWORD) <span class="hljs-literal">NULL</span>) )<br>    &#123; <br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AdjustTokenPrivileges error: %u\n&quot;</span>, GetLastError() ); <br>          <span class="hljs-keyword">return</span> FALSE; <br>    &#125; <br><br>    <span class="hljs-keyword">if</span> (GetLastError() == ERROR_NOT_ALL_ASSIGNED)<br><br>    &#123;<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The token does not have the specified privilege. \n&quot;</span>);<br>          <span class="hljs-keyword">return</span> FALSE;<br>    &#125; <br><br>    <span class="hljs-keyword">return</span> TRUE;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="检测硬件断点"><a href="#检测硬件断点" class="headerlink" title="检测硬件断点"></a>检测硬件断点</h2><p>这段代码首先会用GetThreadContext来获取drx7寄存器的值，判断是否存在硬件断点，判断存在硬件断点后，试图去掉硬件断点，也就是给drx7赋值为0，如果不行就退出进程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sub_4015E0</span><span class="hljs-params">()</span><br>&#123;<br>  HANDLE CurrentThread; <span class="hljs-comment">// esi</span><br>  CONTEXT Context; <span class="hljs-comment">// [esp+4h] [ebp-2D0h] BYREF</span><br><br>  <span class="hljs-built_in">memset</span>(&amp;Context.Dr0, <span class="hljs-number">0</span>, <span class="hljs-number">0x2C8</span>u);<br>  Context.ContextFlags = <span class="hljs-number">65599</span>;<br>  CurrentThread = GetCurrentThread();<br>  <span class="hljs-keyword">if</span> ( !GetThreadContext(CurrentThread, &amp;Context) || !Context.Dr7 )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  Context.Dr7 = <span class="hljs-number">0</span>;<br>  SetThreadContext(CurrentThread, &amp;Context);<br>  Context.ContextFlags = <span class="hljs-number">65599</span>;<br>  <span class="hljs-keyword">if</span> ( GetThreadContext(CurrentThread, &amp;Context) )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( Context.Dr7 )<br>      ExitProcess(<span class="hljs-number">0xFFFFFF9D</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/11/09/pwn%E5%8A%A0%E8%BD%BD%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AClibc%E8%B0%83%E8%AF%95%E7%A8%8B%E5%BA%8F/">pwn加载不同版本libc调试程序 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img alt="Logo"></a><h1 id="Dr"><a href="Dr.l0v3m1ng">Dr.l0v3</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%AD%A5%E9%AA%A4"><span class="toc-number">1.</span> <span class="toc-text">解题步骤</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%94%B6%E8%8E%B7"><span class="toc-number">2.</span> <span class="toc-text">一些收获</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E5%8D%87%E8%BF%9B%E7%A8%8B%E6%9D%83%E9%99%90"><span class="toc-number">2.1.</span> <span class="toc-text">提升进程权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E7%A1%AC%E4%BB%B6%E6%96%AD%E7%82%B9"><span class="toc-number">2.2.</span> <span class="toc-text">检测硬件断点</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{code.findCode();}</script><script src="/js/arknights.js"></script><script src="/js/pjax.js"></script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>